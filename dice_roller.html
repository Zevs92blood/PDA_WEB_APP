<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=windows-1251"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>Кубомет Daggerheart v3.8 (iPAQ)</title>
    <style>
        body {
            font-family: Tahoma, sans-serif;
            font-size: 14px;
            background-color: #000;
            color: #fff;
            margin: 0;
            padding: 5px;
        }
        h1 {
            font-size: 16px;
            color: #00ffff;
            text-align: center;
            border-bottom: 1px solid #00ffff;
            padding-bottom: 5px;
            margin-bottom: 5px;
        }
        h3 {
            font-size: 14px;
            color: #000;
            margin: 5px 0;
        }
        .controls {
            padding: 5px;
            border: 1px solid #AAA; 
            margin-bottom: 10px;
            background-color: #FFF; 
            color: #000;
        }
        label, select, button, input[type="checkbox"] {
            display: inline-block;
            padding: 4px;
            margin: 3px 1px;
            font-size: 13px; 
            border: 1px solid #777;
            box-sizing: border-box;
            background-color: #FFF;
            color: #000;
        }
        select { width: 45px; text-align: center; } /* Уменьшено для селекторов */
        .full-width-select { width: 98%; }
        button {
            background-color: #007bff;
            color: white;
            font-weight: bold;
            cursor: pointer;
            width: 98%; 
            margin-top: 5px;
        }
        #result-box {
            border: 2px solid #00ffff; 
            padding: 10px;
            margin-bottom: 10px;
            background-color: #333; 
            min-height: 40px;
            text-align: center; 
            color: #fff;
            font-size: 16px;
            font-weight: bold;
        }
        .hidden { display: none; }
    </style>
</head>
<body id="body">

    <h1>Кубомет Daggerheart v3.8 (iPAQ)</h1>

    <div class="controls">
        <h3>1. Обычный бросок</h3>
        <select id="dice-count" style="width: 45px;">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
        </select>
        <select id="dice-type" class="full-width-select" style="width: 45px;">
            <option value="4">к4</option>
            <option value="6">к6</option>
            <option value="8">к8</option>
            <option value="10">к10</option>
            <option value="12">к12</option>
            <option value="20">к20</option>
            <option value="100">к100</option>
        </select>
        <label>Мод:</label>
        <select id="mod-basic" style="width: 45px;">
            <option value="0">0</option>
            <option value="1">+1</option>
            <option value="2">+2</option>
            <option value="3">+3</option>
            <option value="-1">-1</option>
            <option value="-2">-2</option>
        </select>
        <button onclick="rollBasicDice(); return false;">Бросить</button>

        <h3>2. Бросок Двойственности (к12 Н/С)</h3>
        <label>Мод:</label>
        <select id="mod-duality" style="width: 45px;">
            <option value="0">0</option>
            <option value="1">+1</option>
            <option value="2">+2</option>
            <option value="3">+3</option>
            <option value="-1">-1</option>
            <option value="-2">-2</option>
        </select>
        <br>
        <input type="checkbox" id="advantage-check"> Преимущество
        <input type="checkbox" id="disadvantage-check"> Помеха
        <button onclick="rollDualityDice(); return false;">Бросить Двойственность</button>
    </div>

    <div id="result-box">
        Добро пожаловать!
    </div>

    <div style="font-size: 10px; color: #555; margin-top: 5px; text-align: right;">v3.8-iPAQ-FINAL</div>

    <script type="text/javascript">
        var resultBoxDiv = document.getElementById('result-box');
        var bodyElement = document.getElementById('body');
        var originalBodyColor = '#000';
        
        function roll(max) {
            return Math.floor(Math.random() * max) + 1;
        }

        // --- ДИСПЕТЧЕР ВЫВОДА (ТОЛЬКО ЧИСТЫЙ ТЕКСТ через innerText) ---
        function updateDisplay_i(logTextPlain, isDuality, outcomeType) {
            // 1. Вывод результата: ИСПОЛЬЗУЕМ ТОЛЬКО .innerText
            resultBoxDiv.innerText = logTextPlain; 
            
            // 2. Смена фона (без анимации)
            if (isDuality) {
                var color;
                if (outcomeType === 'CRIT') {
                    color = '#FFFF00';
                } else if (outcomeType === 'HOPE') {
                    color = '#008000';
                } else if (outcomeType === 'FEAR') {
                    color = '#FF0000';
                } else {
                    color = originalBodyColor;
                }
                bodyElement.style.backgroundColor = color;
            } else {
                bodyElement.style.backgroundColor = originalBodyColor; 
            }
        }
        
        // --- ЛОГИКА БРОСКОВ ---
        function rollBasicDice() {
            var count = parseInt(document.getElementById('dice-count').value || '1');
            var type = parseInt(document.getElementById('dice-type').value);
            // Изменение: получаем значение из select
            var mod = parseInt(document.getElementById('mod-basic').value || '0'); 
            
            if (count < 1 || count > 10) count = 1; 

            var totalRoll = 0;
            var rolls = [];
            
            for (var i = 0; i < count; i++) {
                var result = roll(type); 
                totalRoll += result;
                rolls.push(result);
            }
            
            var finalTotal = totalRoll + mod;
            var modSign = mod >= 0 ? '+' : '';
            
            // Чистый текст, переносы - \n
            var logTextPlain = `ОБЫЧНЫЙ БРОСОК: к${type} (${count} шт.)\nБроски: ${rolls.join('+')}\nМод: ${modSign}${mod}\nИТОГ: ${finalTotal}`;
            
            updateDisplay_i(logTextPlain, false, null);
        }

        function rollDualityDice() {
            // Изменение: получаем значение из select
            var mod = parseInt(document.getElementById('mod-duality').value || '0');
            var isAdvantage = document.getElementById('advantage-check').checked;
            var isDisadvantage = document.getElementById('disadvantage-check').checked;

            var hopeRoll = roll(12);
            var fearRoll = roll(12);
            var dualityMod = 0;
            
            if (isAdvantage && !isDisadvantage) {
                dualityMod = roll(6);
            } else if (isDisadvantage && !isAdvantage) {
                dualityMod = -roll(6);
            }

            var finalTotal = hopeRoll + mod + dualityMod; 
            var finalMod = mod + dualityMod;
            var modSign = finalMod >= 0 ? '+' : '';
            
            var outcomeText, outcomeType;

            if (hopeRoll === fearRoll) {
                outcomeText = 'КРИТ. УСПЕХ';
                outcomeType = 'CRIT';
            } else if (hopeRoll > fearRoll) {
                outcomeText = 'НАДЕЖДА';
                outcomeType = 'HOPE';
            } else { 
                outcomeText = 'СТРАХ';
                outcomeType = 'FEAR';
            }
            
            // Чистый текст, переносы - \n
            var logTextPlain = `ДВОЙСТВЕННОСТЬ (к12)\nНадежда: ${hopeRoll} / Страх: ${fearRoll}\nМод: ${modSign}${finalMod}\nИТОГ: ${finalTotal} / Исход: ${outcomeText}`;
            
            updateDisplay_i(logTextPlain, true, outcomeType);
        }

        // --- Инициализация ---
        window.onload = function() {
            document.getElementById('advantage-check').addEventListener('change', function() {
                if (this.checked) document.getElementById('disadvantage-check').checked = false;
            });
            document.getElementById('disadvantage-check').addEventListener('change', function() {
                if (this.checked) document.getElementById('advantage-check').checked = false;
            });
            
            // Убедимся, что начальный текст отображается через innerText
            resultBoxDiv.innerText = 'Добро пожаловать!';
        };
    </script>
</body>
</html>
