<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>Кубомет Daggerheart v4.2 (iPAQ)</title>
    <style>
        /* Стиль, оптимизированный под iPAQ */
        body { 
            font-family: Tahoma, sans-serif;
            text-align: center; 
            color: #FFF;
            background-color: #000000;
            padding: 5px;
        }
        h2 { color: #FFF; margin-bottom: 15px; font-size: 16px; }
        h3 { color: #000; margin-top: 10px; font-size: 14px; } 
        .controls { 
            margin-bottom: 15px; 
            border: 1px solid #AAA; 
            padding: 10px; 
            background-color: #FFF;
            color: #333;
        }
        /* Группа ввода, используем flex для горизонтального расположения */
        .input-group { margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        label { font-size: 14px; margin-right: 5px; }
        
        /* Общие стили для полей ввода и кнопок */
        input[type="number"], select, button { 
            padding: 8px; 
            font-size: 14px;
            margin: 5px 0; 
            width: 100%; 
            box-sizing: border-box; 
        }
        input[type="number"] { width: 50px; text-align: center; }
        
        button { 
            cursor: pointer; 
            background-color: #007bff; 
            color: white; 
            border: none; 
            font-weight: bold;
        }

        #result-box { 
            margin-top: 20px; 
            padding: 10px; 
            border: 2px solid #00ffff;
            min-height: 80px; 
            background-color: #333;
        }
        
        #result-text { 
            font-size: 16px; 
            font-weight: bold;
            text-align: center;
            color: #fff;
        }
        
        /* Стили для элементов "Обычного броска" - МАКЕТ 4.2 */
        .basic-dice-selector { width: 25%; } /* Увеличено, чтобы вместить все */
        .basic-mod-input { width: 20%; }
        /* Новое поле ввода для количества кубов */
        .basic-count-input { width: 20%; } 
        .basic-label { width: 10%; text-align: right;}
        
    </style>
</head>
<body id="body">

    <h2>Кубомет Daggerheart v4.2 (iPAQ)</h2>

    <div class="controls">
        <h3>Двойственность (к12 Н/С)</h3>
        <div class="input-group">
            <label for="modifier_i">Модификатор:</label>
            <input type="number" id="modifier_i" value="0" min="-99" max="99" style="width: 50%;">
        </div>

        <div class="input-group" style="justify-content: space-around;">
            <div>
                <label for="advantage_i">Преимущество</label>
                <input type="checkbox" id="advantage_i">
            </div>
            <div>
                <label for="disadvantage_i">Помеха</label>
                <input type="checkbox" id="disadvantage_i">
            </div>
        </div>
        
        <button onclick="rollDuality_i(); return false;">Бросить Двойственность</button>
    </div>

    <div class="controls">
        <h3>Обычный бросок</h3>
        <div class="input-group" style="justify-content: space-around;">
            
            <label class="basic-label" for="dice-count" style="width: 15%;">Кол-во:</label>
            <input type="number" id="dice-count" value="1" min="1" max="99" class="basic-count-input">
            
            <label class="basic-label" for="dice-type" style="width: 10%;">Куб:</label>
            <select id="dice-type" class="basic-dice-selector">
                <option value="4">к4</option>
                <option value="6">к6</option>
                <option value="8">к8</option>
                <option value="10">к10</option>
                <option value="12">к12</option>
                <option value="20" selected>к20</option>
                <option value="100">к100</option>
            </select>
            
            <label class="basic-label" for="d20-modifier_i" style="width: 10%;">Мод:</label>
            <input type="number" id="d20-modifier_i" value="0" min="-99" max="99" class="basic-mod-input">
        </div>
        <button onclick="rollBasicDice(); return false;">Бросить</button>
    </div>
    
    <div id="result-box">
        <div id="result-text">
            Добро пожаловать!
        </div>
    </div>

    <div style="font-size: 10px; color: #999; margin-top: 15px; text-align: right;">Версия: v4.2-iPAQ</div>

    <script>
        // --- УТИЛИТЫ ---
        function getElement(id) {
            return document.getElementById(id);
        }
        
        function roll(max) {
            return Math.floor(Math.random() * max) + 1;
        }

        // Окрашивание фона (без анимации)
        function updateBackground_i(outcomeType) {
            var color;
            if (outcomeType === 'CRIT') {
                color = '#FFFF00'; // Желтый для Крита
            } else if (outcomeType === 'HOPE') {
                color = '#008000'; // Зеленый для Надежды
            } else if (outcomeType === 'FEAR') {
                color = '#FF0000'; // Красный для Страха
            } else {
                color = '#000000'; // Черный для обычных бросков
            }
            getElement('body').style.backgroundColor = color;
        }

        // --- DUALITY (к12 Н/С) ---
        function rollDuality_i() {
            var mod = parseInt(getElement('modifier_i').value || '0');
            var adv = getElement('advantage_i').checked;
            var dis = getElement('disadvantage_i').checked;
            
            getElement('result-text').innerHTML = 'Бросаем к12...';

            var roll1 = roll(12);
            var roll2 = roll(12);
            
            var successRoll = roll1;
            var stressRoll = roll2;

            if (adv && !dis) {
                successRoll = Math.max(roll1, roll2);
                stressRoll = Math.min(roll1, roll2); 
            } else if (dis && !adv) {
                successRoll = Math.min(roll1, roll2);
                stressRoll = Math.max(roll1, roll2);
            }

            var finalSuccess = successRoll + mod;
            
            var outcomeText;
            var outcomeType;
            
            if (successRoll === stressRoll) {
                outcomeText = 'КРИТ. УСПЕХ';
                outcomeType = 'CRIT';
            } else if (successRoll > stressRoll) {
                outcomeText = 'НАДЕЖДА';
                outcomeType = 'HOPE';
            } else {
                outcomeText = 'СТРАХ';
                outcomeType = 'FEAR';
            }

            // Формат вывода: Н: 5 / С: 5 / Мод: +0 / ИТОГ: 5 / Исход: КРИТ. УСПЕХ
            var resultHTML = 
                'Н: ' + successRoll + ' / С: ' + stressRoll + 
                ' / Мод: ' + (mod >= 0 ? '+' : '') + mod + 
                ' / ИТОГ: ' + finalSuccess + 
                ' / Исход: ' + outcomeText;

            updateBackground_i(outcomeType); 
            
            getElement('result-text').innerHTML = resultHTML;
            return false;
        }

        // --- ОБЫЧНЫЙ БРОСОК (кD) ---
        function rollBasicDice() {
            var count = parseInt(getElement('dice-count').value || '1');
            var type = parseInt(getElement('dice-type').value);
            var mod = parseInt(getElement('d20-modifier_i').value || '0');
            
            // Защита от 0 или отрицательного количества кубов
            if (count < 1) count = 1;

            getElement('result-text').innerHTML = 'Бросаем ' + count + 'к' + type + '...';

            var totalRoll = 0;
            var rolls = [];
            
            for (var i = 0; i < count; i++) {
                var rollValue = roll(type); 
                totalRoll += rollValue;
                rolls.push(rollValue);
            }
            
            var total = totalRoll + mod;
            var modSign = mod >= 0 ? '+' : '';

            // Формат вывода: [1к20] Броски: (2); Мод: +0; ИТОГ: 2
            var resultHTML = 
                '[' + count + 'к' + type + '] Броски: (' + rolls.join('+') + ');' +
                ' Мод: ' + modSign + mod + ';' +
                ' ИТОГ: ' + total;

            // Обновляем фон (обычные броски - всегда черный фон)
            updateBackground_i(null); 
            
            getElement('result-text').innerHTML = resultHTML;
            return false;
        }

        // --- Инициализация ---
        window.onload = function() {
            // Логика переключения Преимущества/Помехи
            getElement('advantage_i').addEventListener('change', function() {
                if (this.checked) getElement('disadvantage_i').checked = false;
            });
            getElement('disadvantage_i').addEventListener('change', function() {
                if (this.checked) getElement('advantage_i').checked = false;
            });
        };
    </script>
</body>
</html>
