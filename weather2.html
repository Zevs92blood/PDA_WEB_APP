<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>Погода для iPAQ (v2.5)</title>
    <style>
        /* CSS без изменений */
        body { font-family: sans-serif; text-align: center; color: #333; transition: background-color 1.5s; }
        #result { margin-top: 20px; padding: 10px; border: 1px solid #AAA; background-color: rgba(255, 255, 255, 0.8); min-height: 50px; text-align: left; }
        .forecast-block { margin-top: 15px; border-top: 1px dashed #666; padding-top: 10px; }
        .hourly-item { margin-top: 5px; font-size: 13px; }
        button { padding: 10px 20px; font-size: 16px; margin-top: 15px; }
        select { padding: 8px; font-size: 14px; margin-bottom: 15px; border: 1px solid #777; }
        h1 { margin-bottom: 5px; }
        .version { font-size: 10px; color: #666; margin-top: 20px; }
        #aqi-result { margin-top: 15px; font-size: 14px; color: #666; }
        .controls { margin-bottom: 15px; }
        .controls label { font-size: 14px; }
    </style>
</head>
<body>

    <h1>Выбор города:</h1>
    
    <select id="city-select">
        <option value="53.05,50.85">Покровка (Н-р-н)</option>
        <option value="53.20,50.15">Самара (Обл. центр)</option>
    </select>
    
    <div class="controls">
        <label>
            <input type="checkbox" id="detail-checkbox"> Подробно
        </label>
    </div>
    
    <button onclick="fetchWeather()">Запросить Прогноз (v2.5)</button>
    
    <div id="result">Ожидание данных...</div>
    <div id="aqi-result"></div>
    
    <div class="version">Версия: 2.5 (Финальный код)</div>

    <script>
        var LOCATIONS = {
            '53.05,50.85': 'Покровке',
            '53.20,50.15': 'Самаре'
        };

        // --- ФУНКЦИЯ ДЛЯ ДИСКРЕТНОГО ФОНА (Без изменений) ---
        function updateBackground(temp) {
            var color;
            if (temp >= 35) color = '#FF0000';
            else if (temp >= 25) color = '#FFA500';
            else if (temp >= 18) color = '#FFFF00';
            else if (temp >= 10) color = '#008000';
            else if (temp >= -5) color = '#ADD8E6';
            else if (temp >= -20) color = '#0000FF';
            else color = '#EE82EE';
            document.body.style.backgroundColor = color;
        }
        
        // --- ОСНОВНАЯ ФУНКЦИЯ ЗАПРОСА ПОГОДЫ (ВКЛЮЧАЕТ AQI) ---
        function fetchWeather() {
            var selectElement = document.getElementById('city-select');
            var resultDiv = document.getElementById('result');
            var aqiDiv = document.getElementById('aqi-result');
            var isDetailed = document.getElementById('detail-checkbox').checked;
            
            var selectedValue = selectElement.value;
            var coords = selectedValue.split(',');
            var LAT = coords[0];
            var LON = coords[1];
            var cityName = LOCATIONS[selectedValue];
            
            resultDiv.innerHTML = 'Загрузка данных для ' + cityName + '...';
            aqiDiv.innerHTML = isDetailed ? 'Загрузка данных о качестве воздуха...' : ''; // Сбрасываем AQI

            var CURRENT_PARAMS = 'temperature_2m,relative_humidity_2m,wind_speed_10m,uv_index,surface_pressure,dew_point_2m';
            var HOURLY_PARAMS = 'temperature_2m,precipitation_probability,wind_speed_10m,uv_index';

            // 1. ЗАПРОС ПОГОДЫ
            var API_URL = 'https://api.open-meteo.com/v1/forecast?latitude=' + LAT + '&longitude=' + LON + '&current=' + CURRENT_PARAMS + '&hourly=' + HOURLY_PARAMS + '&forecast_days=2&timezone=UTC%2B04%3A00';

            var xhr = new XMLHttpRequest();
            
            if (!xhr) {
                resultDiv.innerHTML = 'Ошибка: Ваш браузер не поддерживает XMLHttpRequest.';
                return;
            }

            xhr.open('GET', API_URL, true);
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            var data = JSON.parse(xhr.responseText);
                            
                            // 1.1 Получение текущих данных
                            var current = data.current;
                            var temp = current.temperature_2m;
                            var humidity = current.relative_humidity_2m;
                            var wind = current.wind_speed_10m;
                            var uv_index = current.uv_index;
                            var pressure = Math.round(current.surface_pressure * 0.75006);
                            var dew_point = current.dew_point_2m;
                            
                            updateBackground(temp);

                            // 1.2 Формирование основного блока
                            var mainHTML = 
                                '<h2>' + selectElement.options[selectElement.selectedIndex].text + '</h2>' +
                                '<h3>Текущая погода:</h3>' +
                                '<p>Температура: <strong>' + temp + ' °C</strong></p>' +
                                '<p>Влажность: <strong>' + humidity + ' %</strong></p>' +
                                '<p>Ветер: <strong>' + wind + ' м/с</strong></p>' +
                                '<p>Обновлено: ' + new Date().toLocaleTimeString() + '</p>';

                            // 1.3 Формирование подробного блока
                            var detailedHTML = '';
                            if (isDetailed) {
                                detailedHTML += '<div class="forecast-block">';
                                detailedHTML += '<h4>Детали для самочувствия:</h4>';
                                detailedHTML += '<p>Давление: <strong>' + pressure + ' мм рт. ст.</strong></p>';
                                detailedHTML += '<p>Точка Росы: <strong>' + dew_point + ' °C</strong></p>';
                                detailedHTML += '<p>УФ-индекс: <strong>' + uv_index + '</strong></p>'; // <-- УФ-индекс в подробном режиме
                                detailedHTML += '</div>';

                                // Прогноз по времени суток
                                var hourly = data.hourly;
                                var now = new Date();
                                var currentHour = now.getHours();

                                var keyHours = [6, 12, 18, 0];
                                var todayHTML = '<h4>Прогноз на сегодня:</h4>';
                                var tomorrowHTML = '<h4>Прогноз на завтра:</h4>';
                                var foundTomorrow = 0;
                                
                                var i;
                                for (i = 0; i < hourly.time.length; i++) {
                                    var hourTime = new Date(hourly.time[i]);
                                    var h = hourTime.getHours();
                                    
                                    if (hourTime.getDate() === now.getDate() && h < currentHour) continue;
                                    
                                    var isKeyHour = false;
                                    var j;
                                    for(j = 0; j < keyHours.length; j++){
                                        if(h === keyHours[j]) {
                                            isKeyHour = true;
                                            break;
                                        }
                                    }
                                    
                                    if (isKeyHour) {
                                        var h_temp = Math.round(hourly.temperature_2m[i]);
                                        var h_pop = hourly.precipitation_probability[i];
                                        var h_wind = Math.round(hourly.wind_speed_10m[i]);
                                        var h_uv = hourly.uv_index[i];

                                        var dayLabel = '';
                                        if (h === 6) dayLabel = 'Утро (6:00)';
                                        else if (h === 12) dayLabel = 'День (12:00)';
                                        else if (h === 18) dayLabel = 'Вечер (18:00)';
                                        else if (h === 0) dayLabel = 'Ночь (0:00)';
                                        
                                        var forecastItem = 
                                            '<div class="hourly-item">' +
                                            '<strong>' + dayLabel + '</strong>: ' +
                                            h_temp + '°C, ' +
                                            h_pop + '% осад., ' +
                                            h_wind + ' м/с, УФ: ' + h_uv +
                                            '</div>';

                                        if (hourTime.getDate() === now.getDate()) {
                                            todayHTML += forecastItem;
                                        } else if (hourTime.getDate() === (now.getDate() + 1)) {
                                            tomorrowHTML += forecastItem;
                                            foundTomorrow++;
                                        }
                                    }
                                    if (foundTomorrow >= 4) break;
                                }

                                detailedHTML += '<div class="forecast-block">' + todayHTML + '</div>';
                                detailedHTML += '<div class="forecast-block">' + tomorrowHTML + '</div>';
                            }
                            
                            // 2. Выводим результат
                            resultDiv.innerHTML = mainHTML + detailedHTML;

                            // 3. ЗАПРОС КАЧЕСТВА ВОЗДУХА (ВНУТРИ ОСНОВНОГО ОБРАБОТЧИКА)
                            if (isDetailed) {
                                var AQI_URL = 'https://air-quality.open-meteo.com/v1/air-quality?latitude=' + LAT + '&longitude=' + LON + '&current=european_aqi,us_aqi&timezone=UTC%2B04%3A00';

                                var xhr_aqi = new XMLHttpRequest();
                                
                                xhr_aqi.open('GET', AQI_URL, true);
                                
                                xhr_aqi.onreadystatechange = function() {
                                    if (xhr_aqi.readyState === 4) {
                                        if (xhr_aqi.status === 200) {
                                            try {
                                                var data_aqi = JSON.parse(xhr_aqi.responseText);
                                                var eu_aqi = data_aqi.current.european_aqi;
                                                var us_aqi = data_aqi.current.us_aqi;
                                                
                                                var aqi_text = '';
                                                if (eu_aqi < 20) aqi_text = 'Хорошее';
                                                else if (eu_aqi < 40) aqi_text = 'Умеренное';
                                                else if (eu_aqi < 60) aqi_text = 'Среднее';
                                                else aqi_text = 'Пониженное';

                                                aqiDiv.innerHTML = 
                                                    '<h3>Качество воздуха (AQI)</h3>' +
                                                    '<p>Европейский индекс: <strong>' + eu_aqi + '</strong> (' + aqi_text + ')</p>' +
                                                    '<p>Американский индекс: <strong>' + us_aqi + '</strong></p>';

                                            } catch (e) {
                                                aqiDiv.innerHTML = 'Не удалось получить данные AQI (ошибка парсинга).';
                                            }
                                        } else {
                                            aqiDiv.innerHTML = 'Ошибка загрузки AQI. Статус: <strong>' + xhr_aqi.status + '</strong> (Вероятно, блокировка Opera Mini или отсутствие данных).';
                                        }
                                    }
                                };
                                
                                xhr_aqi.send();
                            } else {
                                aqiDiv.innerHTML = '';
                            }

                        } catch (e) {
                            resultDiv.innerHTML = '<h2>Ошибка парсинга (v2.5)!</h2><p>Не могу обработать ответ сервера.</p><pre>' + e.toString() + '</pre>';
                        }
                    } else {
                        resultDiv.innerHTML = '<h2>Ошибка HTTP!</h2><p>Статус: ' + xhr.status + ' ' + (xhr.statusText || '') + '</p>';
                    }
                }
            };
            
            xhr.send();
        }
    </script>
</body>
</html>
