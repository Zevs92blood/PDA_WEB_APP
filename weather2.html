<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>Погода для iPAQ (v2.2)</title>
    <style>
        body { font-family: sans-serif; text-align: center; color: #333; transition: background-color 1.5s; }
        #result { margin-top: 20px; padding: 10px; border: 1px solid #AAA; background-color: rgba(255, 255, 255, 0.8); min-height: 50px; text-align: left; }
        .forecast-block { margin-top: 15px; border-top: 1px dashed #666; padding-top: 10px; }
        .hourly-item { margin-top: 5px; font-size: 13px; }
        button { padding: 10px 20px; font-size: 16px; margin-top: 15px; }
        select { padding: 8px; font-size: 14px; margin-bottom: 15px; border: 1px solid #777; }
        h1 { margin-bottom: 5px; }
        .version { font-size: 10px; color: #666; margin-top: 20px; }
    </style>
</head>
<body>

    <h1>Выбор города:</h1>
    
    <select id="city-select">
        <option value="53.05,50.85">Покровка (Н-р-н)</option>
        <option value="53.20,50.15">Самара (Обл. центр)</option>
    </select>
    
    <button onclick="fetchWeather()">Запросить Прогноз (v2.2)</button>
    
    <div id="result">Ожидание данных...</div>
    
    <div class="version">Версия: 2.2 (Дискретный цвет, 4 времени суток)</div>

    <script>
        var LOCATIONS = {
            '53.05,50.85': 'Покровке',
            '53.20,50.15': 'Самаре'
        };

        // --- ФУНКЦИЯ ДЛЯ ДИСКРЕТНОГО ФОНА ---
        function updateBackground(temp) {
            var color;
            
            // Цветовые зоны
            if (temp >= 35) {
                color = '#FF0000'; // Красный (35+)
            } else if (temp >= 25) {
                color = '#FFA500'; // Оранжевый (25-34)
            } else if (temp >= 18) {
                color = '#FFFF00'; // Желтый (18-24)
            } else if (temp >= 10) {
                color = '#008000'; // Зеленый (10-17)
            } else if (temp >= -5) {
                color = '#ADD8E6'; // Голубой (-5 - 9)
            } else if (temp >= -20) {
                color = '#0000FF'; // Синий (-20 - -6)
            } else {
                color = '#EE82EE'; // Фиолетовый (-21 и ниже)
            }
            
            document.body.style.backgroundColor = color;
        }
        
        // --- ОСНОВНАЯ ФУНКЦИЯ ЗАПРОСА ДАННЫХ ---
        function fetchWeather() {
            var selectElement = document.getElementById('city-select');
            var resultDiv = document.getElementById('result');
            
            var selectedValue = selectElement.value;
            var coords = selectedValue.split(',');
            var LAT = coords[0];
            var LON = coords[1];
            var cityName = LOCATIONS[selectedValue];
            
            resultDiv.innerHTML = 'Загрузка данных для ' + cityName + '...';

            // Запрашиваем 48 часов для получения данных на завтра
            var API_URL = 'https://api.open-meteo.com/v1/forecast?latitude=' + LAT + '&longitude=' + LON + '&current=temperature_2m,relative_humidity_2m,wind_speed_10m&hourly=temperature_2m,precipitation_probability,wind_speed_10m&forecast_days=2&timezone=UTC%2B04%3A00';

            var xhr = new XMLHttpRequest();
            
            if (!xhr) {
                resultDiv.innerHTML = 'Ошибка: Ваш браузер не поддерживает XMLHttpRequest.';
                return;
            }

            xhr.open('GET', API_URL, true);
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            var data = JSON.parse(xhr.responseText);
                            
                            // 1. Текущая погода
                            var current = data.current;
                            var temp = current.temperature_2m;
                            var humidity = current.relative_humidity_2m;
                            var wind = current.wind_speed_10m;
                            
                            // Обновляем фон
                            updateBackground(temp);

                            // 2. Формирование прогноза (4 ключевых времени: 6, 12, 18, 24/00)
                            var hourly = data.hourly;
                            var now = new Date();
                            var currentHour = now.getHours();

                            var keyHours = [6, 12, 18, 0]; // Утро, День, Вечер, Ночь
                            var todayHTML = '<h4>Прогноз на сегодня:</h4>';
                            var tomorrowHTML = '<h4>Прогноз на завтра:</h4>';
                            var foundToday = 0;
                            var foundTomorrow = 0;
                            
                            // 2.1. Поиск данных
                            var i;
                            for (i = 0; i < hourly.time.length; i++) {
                                var hourTime = new Date(hourly.time[i]);
                                var h = hourTime.getHours();
                                
                                // Отсекаем прошедшие часы в текущем дне
                                if (hourTime.getDate() === now.getDate() && h < currentHour) continue;
                                
                                // Проверяем, является ли час ключевым
                                var isKeyHour = false;
                                var j;
                                for(j = 0; j < keyHours.length; j++){
                                    if(h === keyHours[j]) {
                                        isKeyHour = true;
                                        break;
                                    }
                                }
                                
                                if (isKeyHour) {
                                    var h_temp = Math.round(hourly.temperature_2m[i]);
                                    var h_pop = hourly.precipitation_probability[i];
                                    var h_wind = Math.round(hourly.wind_speed_10m[i]);

                                    var dayLabel = '';
                                    if (h === 6) dayLabel = 'Утро (6:00)';
                                    else if (h === 12) dayLabel = 'День (12:00)';
                                    else if (h === 18) dayLabel = 'Вечер (18:00)';
                                    else if (h === 0) dayLabel = 'Ночь (0:00)';
                                    
                                    var forecastItem = 
                                        '<div class="hourly-item">' +
                                        '<strong>' + dayLabel + '</strong>: ' +
                                        h_temp + '°C, ' +
                                        h_pop + '% осад., ' +
                                        h_wind + ' м/с' +
                                        '</div>';

                                    if (hourTime.getDate() === now.getDate()) {
                                        todayHTML += forecastItem;
                                        foundToday++;
                                    } else if (hourTime.getDate() === (now.getDate() + 1) || h === 0) { // +1 день
                                        tomorrowHTML += forecastItem;
                                        foundTomorrow++;
                                    }
                                }
                                
                                // Ограничение: если нашли 4 точки на завтра, можно не искать дальше
                                if (foundTomorrow >= 4) break;
                            }
                            
                            // 3. Вывод результата
                            resultDiv.innerHTML = 
                                '<h2>' + selectElement.options[selectElement.selectedIndex].text + '</h2>' +
                                '<h3>Текущая погода:</h3>' +
                                '<p>Температура: <strong>' + temp + ' °C</strong></p>' +
                                '<p>Влажность: <strong>' + humidity + ' %</strong></p>' +
                                '<p>Ветер: <strong>' + wind + ' м/с</strong></p>' +
                                '<p>Обновлено: ' + new Date().toLocaleTimeString() + '</p>' +
                                '<div class="forecast-block">' + todayHTML + '</div>' +
                                '<div class="forecast-block">' + tomorrowHTML + '</div>';

                        } catch (e) {
                            resultDiv.innerHTML = '<h2>Ошибка парсинга (v2.2)!</h2><p>Не могу обработать ответ сервера.</p><pre>' + e.toString() + '</pre>';
                        }
                    } else {
                        resultDiv.innerHTML = '<h2>Ошибка HTTP!</h2><p>Статус: ' + xhr.status + ' ' + (xhr.statusText || '') + '</p>';
                    }
                }
            };
            
            xhr.send();
        }
    </script>
</body>
</html>
